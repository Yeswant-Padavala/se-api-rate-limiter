name: CI - Rate Limiter

on:
  push:
    branches: [ main, master ]
  pull_request:

jobs:
  build-and-test:
    runs-on: ubuntu-latest

    steps:
    # --- CHECKOUT PROJECT ---
    - name: Checkout repository
      uses: actions/checkout@v3

    # --- SETUP NODE ---
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: "18"
        cache: "npm"

    # --- INSTALL DEPENDENCIES ---
    - name: Install dependencies
      run: npm install

    # --- FIX JEST PERMISSIONS (IMPORTANT) ---
    - name: Fix Jest execute permission
      run: chmod +x node_modules/.bin/jest

    # --- OPTIONAL: LINTING (REMOVE IF YOU DON'T USE ESLINT) ---
    - name: Run ESLint
      continue-on-error: true
      run: |
        if [ -f ".eslintrc.json" ] || [ -f ".eslintrc.js" ]; then
          npx eslint .
        else
          echo "No ESLint config found, skipping."
        fi

    # --- RUN TESTS WITH COVERAGE ---
    - name: Run Jest tests with coverage
      run: npm test

    # --- SUMMARIZE COVERAGE RESULTS ---
    - name: Append Coverage to GitHub Summary
      run: |
        echo "### ðŸ§ª Jest Coverage Report" >> $GITHUB_STEP_SUMMARY
        npx jest --coverage --coverageReporters=text-summary >> $GITHUB_STEP_SUMMARY

    # --- SAVE COVERAGE ARTIFACT ---
    - name: Upload Coverage Artifact
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage/
